<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <title>Home &mdash; Leandro Pereira</title>
            <link rel="stylesheet" href="_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="_static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="_static/main.css" type="text/css">
            <link rel="stylesheet" href="_static/flat.css" type="text/css">
            <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="_static/webfont.css" type="text/css">
        <link rel="shortcut icon" href="_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="next" title="Older" href="page2.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            // Scroll to content if on small screen
            if (screen.width < 480)
            {
                $(document).scrollTop(document.getElementsByTagName("article")[0].offsetTop - 44);
            }
        });
    </script></head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><header>
            <hgroup>
              <h1><a href="#">Leandro Pereira</a></h1><h2>Geek in training</h2></hgroup>
          </header>
      <nav>
            <ul><li class="main-nav">
                  <a href="#">Home</a>
                </li>
              <li class="main-nav">
                  <a href="pages/about.html">About</a>
                </li>
              </ul>
          </nav><div class="main-container"><div class="main wrapper clearfix"><article><div class="timestamp postmeta">
            <span>08 December 2013</span>
        </div>
        <div class="section" id="reducing-lwan-memory-usage">
<h1><a href="2013/12/08/reducing_lwan_memory_usage.html">Reducing Lwan memory usage</a></h1>
<p>One of the things that bothers me when I’m writing software is that I <a class="reference external" href="https://www.youtube.com/watch?v=csyL9EC0S0c">never
get things right the first time</a>.  It takes me quite a few iterations to
achieve a good result – be it performance, memory usage, or a good
architecture.  Getting things to a “good enough” state is also very frequent
as projects need to move forward; however, written code often ends up in
sort of a low priority refactoring thread inside my head.  Sometimes this
thread is able to produce a thing or two, and I’m able to revisit these
things.</p>
<div class="figure align-center">
<img alt="projectmovingforward" src="http://farm1.staticflickr.com/64/169229347_f554a9c9ea.jpg"/>
<p class="caption">Project moving forward picture by <a class="reference external" href="http://www.flickr.com/photos/tsdesign">Todd Smith</a>.</p>
</div>
<div class="section" id="background-toys">
<h2>Background toys</h2>
<p>One of the things that were in that refactoring thread was <a class="reference external" href="http://github.com/lpereira/lwan">my toy web
server</a>‘s memory usage.  It would consume a whopping <strong>840MB</strong> of memory
while idling; recent commits dropped this amount to a mere <strong>32MB</strong> (with
maybe some more room to spare).  This was only possible because I know the
code inside out and was able to refactor the code a few times.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="2013/12/08/http://i.imgur.com/xSB5PZp.png"><img alt="massifscreenshot0" src="http://i.imgur.com/xSB5PZp.png" style="width: 100%;"/></a>
<p class="caption">Massif-visualizer windows shown at different scales.</p>
</div>
</div>
<div class="section" id="structure-diet">
<h2>Structure diet</h2>
<p>Lwan allocates almost all memory it is going to need even before creating
the main socket.  This means it has to keep around some structures with
information about connections, requests, and their responses.</p>
<p>The first drop in memory usage was the highest one. It was possible because
the structure that keep state for these things also kept state that was only
useful during the request parsing stage.  By segregating this temporary
state to another structure, which is allocated in the request parsing
routine stack, memory usage fell dramatically.</p>
<p>Lots of flags were saved using bitfields in different substructures. Most of
these were booleans, and having less than 32 of them meant I could coalesce
all of them in a single unsigned integer.  Memory usage dropped again.</p>
</div>
<div class="section" id="architecture-smell">
<h2>Architecture smell</h2>
<p>Then a few months passed, and out of the blue I realized that there was
something wrong in the architecture: the same structure I was using to track
request state, I was also using to track connection state.</p>
<p>So I moved all things that only matters to a connection to a structure –
which is the structure that’s preallocated on startup – and made the
request structure be allocated in the request processor routine’s stack.
This stack lives in a coroutine – which won’t use more memory than it was
already allocated for the coroutine stack.  Another worthy reduction of
memory usage.</p>
<p>This also made keep-alive connections a tiny bit faster, as there’s no need to
<span class="docutils literal"><span class="pre">memset()</span></span> the request structure to clean state for the next request
anymore.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="2013/12/08/http://i.imgur.com/3BrC0KB.png"><img alt="massifscreenshot" src="http://i.imgur.com/3BrC0KB.png" style="width: 100%;"/></a>
<p class="caption">Same scale this time. <em>That drop</em>.</p>
</div>
</div>
<div class="section" id="reducing-it-further">
<h2>Reducing it further</h2>
<p>There’s another possibility for memory reduction, but I’m not sure if it is
worthy implementing.</p>
<p>Lwan uses <span class="docutils literal"><span class="pre">epoll()</span></span> – and when a file descriptor is added to a poller,
one can pass arbitrary data inside <span class="docutils literal"><span class="pre">epoll_data_t</span></span>, up to 64-bit in size.
Both the file descriptor and the remote IP address could then be passed as
this data, removing both fields from the connection structure.</p>
<p>This is possible because these are constant values while the connection is
active; everything else is either useless to identify the connection (the
file descriptor is used as an index in an array of connections) or changes
all the time, such as the flags (which would incur the penalty of calling
<span class="docutils literal"><span class="pre">epoll_ctl()</span></span> every time they change).</p>
<p>This would reduce structures by a few megabytes, which isn’t really worth
the effort considering IPv6 support would need to be implemented someday and
this trick would be then rendered useless.  Maybe my refactoring thread will
be able to answer that in a few months.</p>
<p>I’m still considering if it is worthy the trouble of leaking the
request/connection abstraction and removing an integer from the request
structure so all request-related flags would be set in the connection
structure.</p>
</div>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Leandro Pereira</span>
        </div>
        
        
        </div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>26 September 2013</span>
        </div>
        <div class="section" id="implementing-sequences-in-lwan-template-engine">
<h1><a href="2013/09/26/implementing_sequences_in_lwan_template_engine.html">Implementing sequences in lwan template engine</a></h1>
<p>When I wrote about lwan’s templating engine on a <a class="reference external" href="http://tia.mat.br/blog/html/2012/11/11/mustache_templates_in_c.html">blog post</a> last year, I
purposedly ommitted the fact that it didn’t support sequences. Took me
almost a year, but I’ve finally implemented it this week. (Lwan is usually a
low priority weekend project. Maybe that should do as an excuse for my
laziness.)</p>
<p>It took me three tries to get this right. <a class="reference external" href="https://en.wikipedia.org/wiki/Rube_Goldberg_machine">Rube Goldberg machine</a> kind of
right, but there’s always some elegance in ingenuity.</p>
<p>The first try would require one to create the list beforehand, and then pass
it to the template engine to render.  Not only cumbersome, but would require
the creation of (potentially) large amounts of temporary objects.</p>
<p>The latter reason lead me to think of a way to implement iterators in C.
This is usually done using callbacks; and although performant, it gets
pretty verbose and tedious as there is usually the need to create structures
to keep state, and different callbacks to initialize, destroy, and advance
the iterator.</p>
<p>Lots of <a class="reference external" href="https://01.org/blogs/imad/2013/welcome-profusion">things happened since then</a>, and this feature sort of creeped
under the low priority rug for the most part of a year.</p>
<p>While writing a completely different program in Python, however, it struck
me: I could use the <a class="reference external" href="http://tia.mat.br/blog/html/2012/09/29/asynchronous_i_o_in_c_with_coroutines.html">coroutine stuff</a> I was already using in lwan and
implement <a class="reference external" href="https://wiki.python.org/moin/Generators">generator functions</a>.  A few minutes later and I had a working
prototype, which can probably be better explained with the help of a
diagram:</p>
<img alt="diagram" class="align-center" src="http://i.imgur.com/VsAfnsC.png"/>
<p>In short, the engine will create a coroutine whenever it finds a
<span class="docutils literal"><span class="pre">{{#sequence}}</span></span> template tag.  This coroutine will start, and will execute
as usual until it yields.</p>
<p>Yielding <span class="docutils literal"><span class="pre">false</span></span>, the engine assumes the iteration ended, and proceeds to
find the next matching <span class="docutils literal"><span class="pre">{{/sequence}}</span></span> tag to continue from there.</p>
<p>On a <span class="docutils literal"><span class="pre">true</span></span> yield, however, the engine will recurse to apply everything is
between the iteration tags, repeating the process when the iteration-end tag
is found and the coroutine yields <span class="docutils literal"><span class="pre">true</span></span> again.</p>
<p>The coroutine is supposed to clean up after itself before returning a
<span class="docutils literal"><span class="pre">false</span></span> value.</p>
<div class="figure align-center">
<img alt="rubegoldbergmachine" src="http://i.imgur.com/7P2yadJ.jpg"/>
<p class="caption">Professor Butts would be proud. Maybe. <a class="reference external" href="https://en.wikipedia.org/wiki/File:Rubenvent.jpg">Source</a>.</p>
</div>
<p>A sample generator function is shown below. It iterates over a directory
with <span class="docutils literal"><span class="pre">readdir()</span></span>, returning <span class="docutils literal"><span class="pre">1</span></span> on new item availability and <span class="docutils literal"><span class="pre">0</span></span> when there
isn’t anything else to do. Notice that initialization, iteration, and cleanup
is all contained within a single function.</p>
<p>Also, notice that there’s no need to copy any values to and from the
structure – calling <span class="docutils literal"><span class="pre">coro_yield()</span></span> will of course maintain the stack
alive, so local variables can be used outside this function as long as a
reference to them can be obtained.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">dir_list_generator</span><span class="p">(</span><span class="kt">coro_t</span> <span class="o">*</span><span class="n">coro</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">DIR</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">file_list</span> <span class="o">*</span><span class="n">fl</span> <span class="o">=</span> <span class="n">coro_get_data</span><span class="p">(</span><span class="n">coro</span><span class="p">);</span>

    <span class="n">dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">ent</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">)))</span> <span class="p">{</span>
      <span class="n">fl</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span>
      <span class="n">coro_yield</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>   <span class="cm">/* !0 means &quot;iter not done yet&quot; */</span>
    <span class="p">}</span>

    <span class="n">closedir</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The details of how the variable descriptors are set up are explained in the
<a class="reference external" href="https://github.com/lpereira/lwan/commit/a4188d73a00cec4c99d50473803c44bfb2218d13">commit message</a> that introduced this change.  (The commit itself is quite
buggy, but whatever I could find has been fixed in <a class="reference external" href="https://github.com/lpereira/lwan">HEAD</a> already.)</p>
<p>In an ideal world, one would use something akin to Golang’s <a class="reference external" href="http://golang.org/doc/effective_go.html#channels">Channels</a>, but
if I were to implement them in lwan it would take perhaps another year.
Plus, they wouldn’t be as efficient as setting some pointers.  But they
might be useful in the future, so I’m not completely discarding the idea.
Although I’ve never written a single line of Go code, I’m reading a lot
about it recently and it is sort of positively impacting the way I think
about programming.  But I digress.</p>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Leandro Pereira</span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                <a href="tags/c.html">C</a>, <a href="tags/lwan.html">lwan</a>, <a href="tags/programming.html">programming</a></span>
        </div>
        </div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>20 July 2013</span>
        </div>
        <div class="section" id="partially-applied-functions-in-c">
<h1><a href="2013/07/20/partial_functions_in_c.html">Partially Applied Functions in C</a></h1>
<p>There are some functions in the standard C library that takes a function
pointer to be used as a callback later on.  Examples include <span class="docutils literal"><span class="pre">atexit()</span></span>
and <span class="docutils literal"><span class="pre">signal()</span></span>.  However, these functions can’t receive an arbitrary
pointer (which could hold some important program state) in addition to the
function pointer, so you’re left with pesky global variables:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cm">/* You have: */</span>
<span class="n">atexit</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span> <span class="cm">/* foo() will have to fetch program state from globals */</span>

<span class="cm">/* Instead of: */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">program_state</span> <span class="n">state</span><span class="p">;</span>
<span class="n">atexit</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span> <span class="cm">/* foo() now have a pointer to program state */</span>
</pre></div>
</div>
<p>Turns out that there’s a workaround, but it involves some black magic.</p>
<p>I believe the overall mechanism to be quite interesting, however I do not
recommend its usage.  Not only because the implementation wastes a whole
<a class="reference external" href="https://en.wikipedia.org/wiki/Page_(computer_memory)">memory page</a> for a callback, but also because I don’t want to encourage
people to perpetuate this kind of take-pointer-to-function-without-argument
nonsense.</p>
<p>I’ll try to explain how this contraption works by showing the smaller parts
first.  I’ll begin with the template function.  The idea is to have a
function whose code can be patched up later – however that code turns out
to be generated by the compiler:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define PARAMETER_CONSTANT 0xFEEDBEEF</span>
<span class="cp">#define FUNCTION_CONSTANT 0xABAD1DEA</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">partial_template_function</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span><span class="n">FUNCTION_CONSTANT</span><span class="p">)((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PARAMETER_CONSTANT</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The funky-looking cast basically says “call a function pointer at
<span class="docutils literal"><span class="pre">FUNCTION_CONSTANT</span></span> with a pointer pointing to <span class="docutils literal"><span class="pre">PARAMETER_CONSTANT</span></span>”. Of
course, if you call this code as is, the program will most likely crash.
The idea is that this generates this code (IA32 assembly):</p>
<div class="highlight-objdump"><div class="highlight"><pre><span class="mh">0f00deba</span> <span class="p">&lt;</span><span class="nf">partial_template_function</span><span class="p">&gt;:</span>
<span class="x">   0:    55                       push   %ebp</span>
<span class="x">   1:    89 e5                    mov    %esp,%ebp</span>
<span class="x">   3:    83 ec 18                 sub    $0x18,%esp</span>
<span class="x">   6:    c7 04 24 ef be ed fe     movl   $0xfeedbeef,(%esp)</span>
<span class="x">   d:    b8 ea 1d ad ab           mov    $0xabad1dea,%eax</span>
<span class="x">  12:    ff d0                    call   *%eax</span>
<span class="x">  14:    c9                       leave</span>
<span class="x">  15:    c3                       ret</span>
</pre></div>
</div>
<p>Even if you don’t know assembly, if you squint a little bit, you can clearly
see the magic constants defined in the C code above.  By writing a trivial
function to patch these magic values to something useful (such as a real
function or some real pointer argument):</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">bool</span>
<span class="nf">patch_pointer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">code_addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">code_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">look_for</span><span class="p">,</span> <span class="kt">void</span>
<span class="o">*</span><span class="n">patch_with</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">code_addr</span><span class="p">;</span>
    <span class="kt">intptr_t</span> <span class="n">look</span> <span class="o">=</span> <span class="p">(</span><span class="kt">intptr_t</span><span class="p">)</span><span class="n">look_for</span><span class="p">;</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">intptr_t</span> <span class="o">*</span><span class="p">)</span><span class="n">code</span><span class="p">)</span> <span class="o">==</span> <span class="n">look</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">union</span> <span class="p">{</span>
              <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">octet</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)];</span>
              <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
            <span class="p">}</span> <span class="n">patch</span><span class="p">;</span>

            <span class="n">patch</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">patch_with</span><span class="p">;</span>
            <span class="n">code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">octet</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="n">code</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">octet</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">code</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">octet</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
            <span class="n">code</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">octet</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">code</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">code_len</span><span class="o">--</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And using it to patch the pointers in a page allocated with <span class="docutils literal"><span class="pre">mmap()</span></span>
(comments and error recovery have been ommitted for brevity; full source
code is linked below):</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">struct</span> <span class="n">Partial</span> <span class="o">*</span>
<span class="nf">partial_new</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">Partial</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">));</span>
    <span class="cm">/* partial_template_function must be declared just before partial_new</span>
<span class="cm">     * so that caller_len is calculated correctly */</span>
    <span class="n">t</span><span class="o">-&gt;</span><span class="n">caller_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)((</span><span class="kt">intptr_t</span><span class="p">)</span><span class="n">partial_new</span> <span class="o">-</span>
          <span class="p">(</span><span class="kt">intptr_t</span><span class="p">)</span><span class="n">partial_template_function</span><span class="p">);</span>

    <span class="n">t</span><span class="o">-&gt;</span><span class="n">caller</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">caller_len</span><span class="p">,</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_READ</span><span class="p">,</span>
          <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">,</span> <span class="n">partial_template_function</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">caller_len</span><span class="p">);</span>

    <span class="n">patch_pointer</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">caller_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">FUNCTION_CONSTANT</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
    <span class="n">patch_pointer</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">caller_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">PARAMETER_CONSTANT</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

    <span class="n">mprotect</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">caller</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">caller_len</span><span class="p">,</span> <span class="n">PROT_EXEC</span> <span class="o">|</span> <span class="n">PROT_READ</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The end result will be a function that can be called without arguments –
which will magically call another function with a given parameter:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">test</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Test called with data=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">Partial</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">partial_new</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x12341337</span><span class="p">);</span>
    <span class="n">atexit</span><span class="p">(</span><span class="n">partial_to_function</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Which, when executed, will print:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">[leandro@navi /tmp]$ ./a.out</span>
<span class="go">Test called with data=0x12341337</span>
</pre></div>
</div>
<p>So there you have it, <a class="reference external" href="https://en.wikipedia.org/wiki/Partial_application">partially applied functions</a> in C. Useful? Hardly.
Interesting?  I think so.  Fun?  Yup.</p>
<p>If you’d like to try, the full source code, with comments and error recovery
is available in this <a class="reference external" href="https://gist.github.com/lpereira/5062388">gist</a>.</p>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Leandro Pereira</span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                <a href="tags/c.html">c</a>, <a href="tags/trick.html">trick</a>, <a href="tags/programming.html">programming</a></span>
        </div>
        </div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>11 November 2012</span>
        </div>
        <div class="section" id="mustache-templates-in-c">
<h1><a href="2012/11/11/mustache_templates_in_c.html">Mustache templates in C</a></h1>
<p>Generating textual output is a lot easier with templates than it is with
handcrafted functions. And it is a lot easier in languages such as Python,
where things like introspection are easy and cheap. But that doesn’t
necessarily mean we can’t do that in C if we know where to look.</p>
<p>I’ve implemented a subset of <a class="reference external" href="http://mustache.github.com">Mustache</a> templates in C that leverages some
tricks that makes template rendering both convenient and efficient. For
instance, if you have a template such as this:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">Hello</span><span class="p">,</span> <span class="p">{{</span><span class="n">name</span><span class="p">}}</span><span class="o">!</span>
</pre></div>
</div>
<p>It can easily be rendered with the following code:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="kt">hello_t</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;World&quot;</span>
<span class="p">};</span>
<span class="n">lwan_tpl_render</span><span class="p">(</span><span class="n">hello</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
<p>Where <span class="docutils literal"><span class="pre">hello</span></span> is the template that was previously compiled into a series of
simple instructions (such as <strong>append text</strong> or <strong>append the value of a
variable</strong>), and the second parameter is a structure containing the data
needed by the renderer.</p>
<p>My first thought to render these templates would involve the use of a hash
table. While reasonably efficient (even considering the overhead to create
and destroy the table every time the template had to be rendered), they’re
not first class citizens in C, and the usage would be pretty clumsy, to say
the least:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">hash_table</span> <span class="o">*</span><span class="n">ht</span> <span class="o">=</span> <span class="n">hash_table_new</span><span class="p">();</span>
<span class="n">hash_table_add</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;World&quot;</span><span class="p">);</span>

<span class="n">lwan_tpl_render</span><span class="p">(</span><span class="n">hello</span><span class="p">,</span> <span class="n">ht</span><span class="p">);</span>

<span class="n">hash_table_free</span><span class="p">(</span><span class="n">ht</span><span class="p">);</span>
</pre></div>
</div>
<p>Instead, I’ve decided to go on another road: use standard C structures to
store the values in their native form, and then find a way to lookup these
values whenever necessary to render the template.</p>
<p>The first trick, then, was to use a C99 feature called <a class="reference external" href="http://gcc.gnu.org/onlinedocs/gcc-3.3.1/gcc/Compound-Literals.html">compound literals</a>,
which is supported by GCC even in C89 mode. This trick allows the use of
<a class="reference external" href="http://www.run.montefiore.ulg.ac.be/~martin/resources/kung-f00.html">anonymous arrays</a>, among other things, and provides enough syntactic sugar
to conveniently group the template variables:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">lwan_tpl_render</span><span class="p">(</span><span class="n">hello</span><span class="p">,</span> <span class="p">(</span><span class="kt">hello_t</span><span class="p">[])</span> <span class="p">{{</span>
  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;World&quot;</span>
<span class="p">}});</span>
</pre></div>
</div>
<p>Without a way to lookup which value to obtain from the structure, however,
this would not help much. Enter the second trick: the <span class="docutils literal"><span class="pre">offsetof(3)</span></span> macro,
which computes the offset of a field in a given structure. By storing this
offset alongside data type information, the value lookup is not only possible
but can also work with types different than strings:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="kt">hello_t</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">age</span><span class="p">;</span>
<span class="p">};</span>
<span class="cm">/*</span>
<span class="cm"> * The TPL_VAR_??? macros provides some convenience to declare each</span>
<span class="cm"> * descriptor. These expand to a declaration containing the name of</span>
<span class="cm"> * the variable as a string (used to validate the template during</span>
<span class="cm"> * compile time), the field offset, and pointers to functions that</span>
<span class="cm"> * convert the values to string and check if they're empty.</span>
<span class="cm"> *</span>
<span class="cm"> * The SENTINEL type is there so the template compiler knows when to</span>
<span class="cm"> * stop looking for descriptors, since of course you can have as</span>
<span class="cm"> many</span>
<span class="cm"> * fields as necessary.</span>
<span class="cm"> */</span>
<span class="kt">lwan_var_descriptor_t</span> <span class="n">hello_descriptor</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">TPL_VAR_STR</span><span class="p">(</span><span class="kt">hello_t</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
  <span class="n">TPL_VAR_INT</span><span class="p">(</span><span class="kt">hello_t</span><span class="p">,</span> <span class="n">age</span><span class="p">),</span>
  <span class="n">TPL_VAR_SENTINEL</span>
<span class="p">};</span>
<span class="kt">lwan_tpl_t</span> <span class="o">*</span><span class="n">hello</span><span class="p">;</span>
<span class="kt">strbuf_t</span> <span class="o">*</span><span class="n">rendered</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * ``hello'' would usually be compiled once and kept around for</span>
<span class="cm"> * the whole duration of the program.</span>
<span class="cm"> */</span>
<span class="n">hello</span> <span class="o">=</span> <span class="n">lwan_tpl_compile</span><span class="p">(</span><span class="s">&quot;hello.tpl&quot;</span><span class="p">,</span> <span class="n">hello_descriptor</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Rendering the template then would be just the matter of calling</span>
<span class="cm"> * this function, which will output a ``strbuf_t''. The template</span>
<span class="cm"> * compiler estimates the starting size of this string buffer, so</span>
<span class="cm"> * rendering will incur in very few expensive reallocations, if</span>
<span class="cm"> * there are reallocations at all.</span>
<span class="cm"> */</span>
<span class="n">rendered</span> <span class="o">=</span> <span class="n">lwan_tpl_render</span><span class="p">(</span><span class="n">hello</span><span class="p">,</span> <span class="p">(</span><span class="kt">hello_t</span><span class="p">[])</span> <span class="p">{{</span>
  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;World&quot;</span><span class="p">,</span>
  <span class="p">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">42</span>
<span class="p">}});</span>

<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strbuf_get_buffer</span><span class="p">(</span><span class="n">rendered</span><span class="p">));</span>
<span class="n">strbuf_free</span><span class="p">(</span><span class="n">rendered</span><span class="p">);</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/lpereira/lwan/blob/wip/template.c">Code for this engine</a> is available in the <a class="reference external" href="https://github.com/lpereira/lwan/tree/wip">wip branch</a> of my toy web
server, lwan. It is not currently used there, but it is built alongside the
main program and can be tested by invoking the generated <span class="docutils literal"><span class="pre">template</span></span>
executable.</p>
<p>Before using that in lwan, though, I’ll try to employ this <a class="reference external" href="http://dginasa.blogspot.com.br/2012/10/brainfuck-jit-compiler-in-around-155.html">nifty trick</a> to
JIT-compile the template and avoid some of the overhead where it really
matters. While at the same time possibly opening a whole can of worms from
the security standpoint, though – but it wouldn’t be fun without some risk,
would it? :)</p>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Leandro Pereira</span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                <a href="tags/lwan.html">lwan</a>, <a href="tags/c.html">C</a>, <a href="tags/tricks.html">tricks</a>, <a href="tags/template.html">template</a></span>
        </div>
        </div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>27 October 2012</span>
        </div>
        <div class="section" id="programming-on-an-arduino-without-a-pc">
<h1><a href="2012/10/27/programming_on_an_arduino_without_a_pc.html">Programming on an Arduino without a PC</a></h1>
<p>I’ve attended this year’s <a class="reference external" href="http://softwarelivre.org/fisl13">FISL</a>, both as a booth attendee (at
<a class="reference external" href="http://profusion.mobi">ProFUSION</a>’s booth, demonstrating a few of our end-user-visible projects),
and as a speaker for my old <a class="reference external" href="http://github.com/lpereira/finf">FINF</a> project.</p>
<p>FINF is a <a class="reference external" href="http://en.wikipedia.org/wiki/Forth_(programming_language)">Forth</a>-like programming environment that I’ve written in my first
year at the college. It’s not the first compiler I wrote, but it was the
first that was actually fun to write. Some years later, I’ve decided to
rewrite it so that it would work on the <a class="reference external" href="http://www.arduino.cc">Arduino</a> – and that’s what I went
to FISL to talk about.</p>
<img alt="audience" class="align-center" src="http://i.imgur.com/AsCOr.jpg"/>
<p>Arduinos are traditionally programmed by using its IDE, in a language that
resembles C++. In fact, it is C++, but some of the (boring) details are
hidden. But, being C++, it’s bound to the slow write-compile-upload-test
procedures; there’s no interactive prompt, such as you have with Python or
the venerable 8-bit Microsoft Basic. And since Arduino is all about
experimentation, an interactive prompt is a must.</p>
<p>FINF is there to fill this gap. It is not a full <a class="reference external" href="http://en.wikipedia.org/wiki/Forth_(programming_language)">FORTH</a> implementation;
only a small subset of it is there, but it’s enough to blink some LEDs, make
some noise, and – if a video output shield is used – use the Arduino as an
8-bit computer! But, since user code actually runs on top of a very simple
virtual machine due to the <a class="reference external" href="http://en.wikipedia.org/wiki/Harvard_architecture">Harvard architecture</a> used by the AVR
microcontroller, it’s not possible to expand the interpreter without getting
dirt in your hands. Add that to the quite messy code, mix it with myself not
being a good marketer, and you have yet another failed open source project of
mine! :)</p>
<p>In any case, the <a class="reference external" href="https://docs.google.com/presentation/d/1w23aLeFgbvjztjtDIFcGTAl7ghlfxsxH_lW4Fyw8lzw/edit">slides</a> (in Portuguese) are available online.
Unfortunately, the presentation was not recorded, so if you were not there,
you’ve missed the great opportunity of seeing myself making a LED blink in
front of an audience.</p>
<p>(By the way, I’ll be talking during EFL Developer Day in Barcelona early next
month. If you’re there for LinuxCon/Embedded Linux Conference and would like
to join me for some beers, don’t hesitate to contact me!)</p>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by Leandro Pereira</span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                <a href="tags/profusion.html">profusion</a>, <a href="tags/finf.html">finf</a>, <a href="tags/conferences.html">conferences</a>, <a href="tags/arduino.html">arduino</a></span>
        </div>
        </div><div class="archive_link">
        <a href="archive.html"> &mdash; Blog Archive &mdash; </a>
    </div><ul class="related clearfix">
            <li class="left"></li>
            <li class="right"><a href="page2.html">Older</a> &raquo; </li>
        </ul></article><aside class="sidebar"><section><div class="widget" id="searchbox">
    <h1>Search</h1>
    <form action="search.html" method="get">
        <input type="text" name="q" />
        <button type="submit"><span class="webfont">L</span></button>
    </form>
</div></section><section><div class="widget">
    <h1>Recent Posts</h1>
    <ul><li>
            <a href="2013/12/08/reducing_lwan_memory_usage.html">Reducing Lwan memory usage</a>
        </li><li>
            <a href="2013/09/26/implementing_sequences_in_lwan_template_engine.html">Implementing sequences in lwan template engine</a>
        </li><li>
            <a href="2013/07/20/partial_functions_in_c.html">Partially Applied Functions in C</a>
        </li><li>
            <a href="2012/11/11/mustache_templates_in_c.html">Mustache templates in C</a>
        </li><li>
            <a href="2012/10/27/programming_on_an_arduino_without_a_pc.html">Programming on an Arduino without a PC</a>
        </li><li>
            <a href="2012/10/14/vectored_i_o_with_mmap___to_serve_files.html">Vectored I/O with mmap() to serve files</a>
        </li><li>
            <a href="2012/09/29/asynchronous_i_o_in_c_with_coroutines.html">Asynchronous I/O in C with Coroutines</a>
        </li><li>
            <a href="2012/09/21/presenting_easyui.html">Presenting EasyUI</a>
        </li><li>
            <a href="2012/08/12/file_serving_with_few_system_calls.html">File serving with few system calls</a>
        </li><li>
            <a href="2012/08/11/deferred_statements_in_c.html">Deferred statements in C</a>
        </li></ul>
</div>
</section><section><div class="widget">
    <h1>Tags Cloud</h1>
      <a href="tags/arduino.html" style="font-size: 8pt">arduino</a>&nbsp;&nbsp;
      <a href="tags/c.html" style="font-size: 17pt">C</a>&nbsp;&nbsp;
      <a href="tags/c.html" style="font-size: 8pt">c</a>&nbsp;&nbsp;
      <a href="tags/conferences.html" style="font-size: 9pt">conferences</a>&nbsp;&nbsp;
      <a href="tags/data_structure.html" style="font-size: 8pt">data-structure</a>&nbsp;&nbsp;
      <a href="tags/efl.html" style="font-size: 8pt">efl</a>&nbsp;&nbsp;
      <a href="tags/enlightenment.html" style="font-size: 8pt">enlightenment</a>&nbsp;&nbsp;
      <a href="tags/finf.html" style="font-size: 8pt">finf</a>&nbsp;&nbsp;
      <a href="tags/javascript.html" style="font-size: 8pt">javascript</a>&nbsp;&nbsp;
      <a href="tags/linux.html" style="font-size: 9pt">linux</a>&nbsp;&nbsp;
      <a href="tags/lwan.html" style="font-size: 18pt">lwan</a>&nbsp;&nbsp;
      <a href="tags/profusion.html" style="font-size: 11pt">profusion</a>&nbsp;&nbsp;
      <a href="tags/programming.html" style="font-size: 20pt">programming</a>&nbsp;&nbsp;
      <a href="tags/strace.html" style="font-size: 8pt">strace</a>&nbsp;&nbsp;
      <a href="tags/template.html" style="font-size: 8pt">template</a>&nbsp;&nbsp;
      <a href="tags/tizen.html" style="font-size: 8pt">tizen</a>&nbsp;&nbsp;
      <a href="tags/trick.html" style="font-size: 12pt">trick</a>&nbsp;&nbsp;
      <a href="tags/tricks.html" style="font-size: 8pt">tricks</a>
</div></section></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container"><footer class="wrapper">&copy; Copyright 2013, Leandro Pereira. Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.</footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>